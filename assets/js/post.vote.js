if(!TB.vote){TB.namespace("vote")}TB.vote.textVote=(function(){var a=YAHOO.util.Dom,n=YAHOO.util.Event,j=YAHOO.util.Connect,c=false,g=5,m=a.getElementsByClassName("j_link"),i=a.getElementsByClassName("j_close"),h=a.getElementsByClassName("j_false"),e=a.getElementsByClassName("btn_true"),b=a.getElementsByClassName("j_showlink_edit"),l=a.getElementsByClassName("j_showlink_del"),k=a.get("j_add_item"),d=a.getChildrenBy(a.get("vote-post"),function(o){return o.tagName=="TR"}),f={init:function(){n.onDOMReady(function(){f.showTips()});n.on(d,"mouseover",function(){f.trShow(this)});n.on(d,"mouseout",function(){f.trHidden(this)});n.on(i,"click",function(){f.trClose(this)});n.on(m,"click",function(){f.linkShow(this)});n.on(h,"click",function(){f.linkFalse(this)});n.on(e,"click",function(){f.linkTrue(this)});n.on(b,"click",function(){f.linkEdit(this)});n.on(k,"click",function(){f.addItem(this)});n.on(l,"click",function(){f.linkDel(this)});n.removeListener(f.getChlid(a.get("j_one"),"DIV","j_close"));n.removeListener(f.getChlid(a.get("j_one"),"img","j_link"));n.removeListener(f.getChlid(a.get("j_one"),"a","j_false"));n.removeListener(f.getChlid(a.get("j_one"),"input","btn_true"));n.removeListener(f.getChlid(a.get("j_one"),"a","j_showlink_edit"));n.removeListener(f.getChlid(a.get("j_one"),"a","j_showlink_del"));var r=0;for(var p=0;p<d.length;p++){if(d[p].style.display!="none"){r++}}if(r>=100){a.get("j_add_item").style.display="none";r=0}var o=f.getArrayChlid(a.get("vote-post"),"div","j_showlink");for(var p=0;p<o.length;p++){var q=f.getChlid(o[p],"a","j_showlink_text");if(document.all){if(q.innerText&&q.innerText.length>32){q.innerText=q.innerText.substr(0,32)+"..."}}else{if(q.textContent.length>32){q.textContent=q.textContent.substr(0,32)+"..."}}if(f.getChlid(o[p],"a","j_showlink_text").title!=""){o[p].style.display="block";a.getLastChild(a.getFirstChild(o[p].parentNode)).style.display="none"}}f.preview()},showTips:function(){obj=a.get("vote-post");if(c||a.getElementsByClassName("j_link2").length>0){return}var o=document.createElement("div");o.id="j_tips";o.style.width="173px";o.style.height="58px";o.style.background="url(http://img04.taobaocdn.com/tps/i4/T1Gc0pXgdXXXXXXXXX-173-58.gif)";o.style.position="absolute";o.style.top="-32px";o.style.left="482px";o.innerHTML="<a href='javascript:void(0)' style='display:block;width:18px;height:18px;float:right'><a/>";var p=a.getAncestorByClassName(obj,"bd");a.setStyle(p,"position","relative");p.appendChild(o);c=true;n.on(a.get("j_tips").firstChild,"click",function(){if(a.get("j_tips")){a.get("j_tips").style.display="none"}})},trShow:function(p){var r=a.getFirstChild(p);r.style.background="#F2F2F2";if(a.getFirstChild(a.getFirstChild(r)).className=="j_close"){a.getFirstChild(a.getFirstChild(r)).style.visibility="visible"}var o=a.getLastChild(a.getFirstChild(a.getFirstChild(p).getElementsByTagName("span")[0].parentNode.parentNode)).className;var q=p.getElementsByTagName("a")[p.getElementsByTagName("a").length-3].title;if(q!=""&&o!="j_link2"){p.getElementsByTagName("a")[p.getElementsByTagName("a").length-2].style.display="inline";p.getElementsByTagName("a")[p.getElementsByTagName("a").length-1].style.display="inline"}},trHidden:function(o){var q=a.getFirstChild(o);q.style.background="#FFF";a.getFirstChild(a.getFirstChild(q)).style.visibility="hidden";var p=o.getElementsByTagName("a")[o.getElementsByTagName("a").length-3].title;o.getElementsByTagName("a")[o.getElementsByTagName("a").length-2].style.display="none";o.getElementsByTagName("a")[o.getElementsByTagName("a").length-1].style.display="none"},trClose:function(r){if(!confirm("\u662f\u5426\u5220\u9664\u6b64\u9009\u9879?")){return}else{r.parentNode.parentNode.parentNode.style.display="none";var o=a.getChildrenBy(a.get("vote-post"),function(s){return s.tagName=="TR"&&(s.style.display!="none")});var q=0;if(o.length<2){r.parentNode.parentNode.parentNode.style.display="block";a.get("add_msg").innerHTML='<p class="error" >\u4e0d\u80fd\u5c11\u4e8e\u6700\u5c0f\u9009\u9879\u6570</p>';a.get("add_msg").style.display="block";setTimeout(function(){a.get("add_msg").style.display="none"},2000);return}for(var p=0;p<o.length;p++){if(o[p].style.display!="none"){o[p].getElementsByTagName("span")[0].innerHTML="\u9009\u9879"+(p+1)+" : ";q++}}a.get("j_add_item").style.display="block"}},linkDel:function(r){r.parentNode.style.display="none";var p=a.getAncestorBy(r,function(s){return s.className=="con"});a.getLastChild(p).getElementsByTagName("a")[0].innerHTML="";a.getLastChild(p).getElementsByTagName("a")[0].title="";p.getElementsByTagName("input")[1].value="";p.getElementsByTagName("img")[0].style.display="inline";try{var o=a.getNextSibling(p.parentNode);o.getElementsByTagName("div")[o.getElementsByTagName("div").length-1].style.display="none"}catch(q){}},linkShow:function(p){if(a.get("j_tips")){a.get("j_tips").style.display="none"}if(a.getPreviousSibling(p).value!=""){var o=a.getNextSibling(p.parentNode);if(o.getElementsByTagName("input")[0].value==""){o.getElementsByTagName("input")[0].value="http://"}p.style.display="none";o.style.display="block"}else{alert("\u8bf7\u9009\u8f93\u5165\u9009\u9879\u5185\u5bb9\uff0c\u7136\u540e\u8fdb\u884c\u8bbe\u7f6e\u94fe\u63a5");return}},linkFalse:function(p){p.parentNode.parentNode.style.display="none";var o=a.getAncestorBy(p,function(q){return q.className=="con"});if(a.getLastChild(o).getElementsByTagName("a")[a.getLastChild(o).getElementsByTagName("a").length-3].title==""){o.getElementsByTagName("img")[0].style.display="inline"}else{a.getLastChild(o).style.display="block"}a.getLastChild(o.parentNode.parentNode).style.display="none"},linkTrue:function(t){var q=a.getPreviousSibling(t).value;if(q.substr(0,7)!="http://"){q="http://"+q;a.getPreviousSibling(t).value=q}var r=q.replace(/[A-Z]/g,function(u){return String.fromCharCode(u.charCodeAt(0)+32)});var s=a.getAncestorBy(t,function(u){return u.className=="con"});if(q.replace(/<[^>]+>/g,"")!=""){if(f.checkUrl(r)){var p=s.parentNode.parentNode;if(a.getPreviousSibling(a.getLastChild(p)).className=="msg-box"){a.getLastChild(p).style.display="none"}else{a.getLastChild(p).style.display="block"}return}var o=q.replace(/<[^>]+>/g,"");a.getLastChild(s).getElementsByTagName("a")[a.getLastChild(s).getElementsByTagName("a").length-3].title=o;if(o.length>32){o=o.substr(0,32)+"..."}a.getLastChild(s).getElementsByTagName("a")[a.getLastChild(s).getElementsByTagName("a").length-3].innerHTML=o;a.getLastChild(s).style.display="block"}else{s.getElementsByTagName("img")[0].style.display="inline"}t.parentNode.parentNode.style.display="none";a.getLastChild(s.parentNode.parentNode).style.display="none"},linkEdit:function(o){o.parentNode.style.display="none";a.getPreviousSibling(o.parentNode).style.display="block";a.getPreviousSibling(o.parentNode).getElementsByTagName("input")[0].value=a.getPreviousSibling(o).title},checkUrl:function(p){var q=function(){var t=/.taobao.com/g;var r=/.taobao.com/g;var s=new RegExp(/.taobao.com/);if(s.test(p)&&p.substr(0,7)=="http://"&&p.substr(p.indexOf("."),20).match(r)){return(false)}else{return(true)}};var o=function(){reg=new RegExp(/alimama|s.click.taobao.com|search8.taobao.com|mall.taobao.com|item.taobao.com|favorite.taobao.com|list.taobao.com|shop/);if(p.match(reg)){return true}else{return false}};return(q())},getChlid:function(q,s,o){var r=q.getElementsByTagName(s);for(var p=0;p<r.length;p++){if(r[p].className==o){return r[p]}}},getArrayChlid:function(r,t,p){var o=[];var s=r.getElementsByTagName(t);for(var q=0;q<s.length;q++){if(s[q].className==p){o.push(s[q])}}return o},preview:function(){n.onDOMReady(function(){var o=function(){var s=a.get("j_radio1");if(s.checked){return 1}else{return a.get("j_multiple").value}};var q=function(){return(a.get("J_Year").value+"-"+a.get("J_Month").value+"-"+a.get("J_Date").value+" "+a.get("J_Hour").value)};var p=function(){g=0;var t=a.getChildrenBy(a.get("vote-post"),function(z){return z.tagName=="TR"&&(z.style.display!="none")});var s="";for(var v=0;v<t.length;v++){var y="";var x=t[v].getElementsByTagName("input")[0].value;var u=t[v].getElementsByTagName("a")[t[v].getElementsByTagName("a").length-3].title;if(x==""&&u!=""){_empty=true;g++}var w=a.getFirstChild(a.getFirstChild(a.getFirstChild(t[v]))).className;if(t[v].style.display!="none"&&w=="j_close"){s+=x+"\u0010"+(u==""?" ":u)+"\u0010"+(y==""?" ":y)+"\u0011"}}return s};var r=new Flower_MaskLayer({color:"#000",timer:400,zindex:6665});n.on("j_preview","click",function(){a.get("maxAnswer").value=o();a.get("endDate").value=q();a.get("j_previewKey").value="true";var u=TB.bom.getCookie("cookie1")||TB.bom.getCookie("_l_g_")||TB.bom.getCookie("ck1");if(u==""){window.location.replace(location.href);return}a.get("msgpost").value=editor.getData();a.get("j_options").value=p();a.get("header").style.zIndex=3333;if(!a.get("j_text-preview")){var s=document.createElement("div");s.id="j_text-preview";s.className="text-preview";a.setStyle(s,"display","none");document.body.appendChild(s)}var t=preview_link+"?_input_charset=utf-8&time="+new Date();j.setForm(document.forms.pollForm);j.asyncRequest("POST",t,{success:function(v){if(v.responseText.indexOf("page-feedback-msg")>-1){a.get("j_msgBox").innerHTML=v.responseText}else{ohtml="<p class='p-v1'><a class='close'></a></p>";ohtml+=v.responseText;ohtml+="<p class='p-v2'><button class='close-v2' type='button'></button></p>";a.get("j_text-preview").innerHTML=ohtml;a.get("j_msgBox").innerHTML="";r.show(function(){a.setStyle("j_text-preview","display","block");a.setStyle("j_text-preview","zIndex",6666);var z=(document.documentElement.scrollTop+(document.documentElement.clientHeight-a.get("j_text-preview").offsetHeight)/2);var y=[(a.getDocumentWidth()-a.get("j_text-preview").offsetWidth)/2,z];a.setXY("j_text-preview",y)})}YAHOO.util.Event.on(window,"resize",function(){if(a.get("j_text-preview").style.display!="none"){a.setStyle("j_text-preview","left",(document.documentElement.scrollWidth-a.get("j_text-preview").offsetWidth)/2+"px")}});var x=a.getFirstChild(a.getFirstChild("j_text-preview")),w=a.getFirstChild(a.getLastChild("j_text-preview"));n.on([x,w],"click",function(){a.setStyle(this.parentNode.parentNode,"display","none");r.hide()});a.get("j_previewKey").value="false"},failure:function(v){}})})})},addItem:function(s){var r=a.get("vote-post").getElementsByTagName("tr");for(var t=0;t<5;t++){var q=0;for(var o=0;o<r.length;o++){if(r[o].style.display!="none"){q++}}if(q>=100){a.get("j_add_item").style.display="none";return}var p=a.getFirstChild(a.get("vote-post")).cloneNode(true);p.getElementsByTagName("span")[0].innerHTML="\u9009\u9879"+(q+1)+" : ";a.get("vote-post").appendChild(p);n.on(p,"mouseover",function(){f.trShow(this)});n.on(p,"mouseout",function(){f.trHidden(this)});n.on(f.getChlid(p,"DIV","j_close"),"click",function(){f.trClose(this)});n.on(f.getChlid(p,"img","j_link"),"click",function(){f.linkShow(this)});n.on(f.getChlid(p,"a","j_false"),"click",function(){f.linkFalse(this)});n.on(f.getChlid(p,"input","btn_true"),"click",function(){f.linkTrue(this)});n.on(f.getChlid(p,"a","j_showlink_edit"),"click",function(){f.linkEdit(this)});n.on(f.getChlid(p,"a","j_showlink_del"),"click",function(){f.linkDel(this)});p.style.display="block";if((q+1)==100){a.get("j_add_item").style.display="none"}}}};return f})();TB.vote.textVote.init();
