(function(){if(!TB.voteImage){TB.namespace("voteImage")}TB.voteImage.vote=(function(){var e=YAHOO.util.Dom,d=YAHOO.util.Event,a=YAHOO.util.Connect,f=0,b={actionUrl:"http://bangpai.taobao.com/json/image_upload.htm",filter:"png|gif|jpg|jpeg"},c={create:function(){var h=e.getChildrenBy(e.get("j_vote-image"),function(j){return j.style.display!="none"&&j.tagName=="LI"});var g=document.createElement("li");var i="<span class='vote-header'><span class='title'>\u9009\u98791</span><a class='close' href='javascript:void(0)'>x</a></span>";i+="<span class='vote-content'>";i+="<a class='vote-imgborder'><div class='vote-table-cell'><img  class='vote-content-img' src='http://img08.taobaocdn.com/tps/i8/T1FCppXg0fXXXXXXXX-180-180.png' alt='\u8d34\u5165\u56fe\u7247'/></div></a>";i+="<input type='text' class='vote-content-text' maxlength='20' value='' />";i+="<img class='j_link' border='0' src='http://img07.taobaocdn.com/tps/i7/T1_d4pXk0BXXXXXXXX-26-22.png' />";i+="<span class='j_add'><input class='j_add-text' type='text' value='http://' /><input class='j_add-true' type='button' value='\u786e\u5b9a' /><a class='j_add-false'   >\u53d6\u6d88</a></span>";i+="<span class='j_linktext'>\u94fe\u63a5\u5230: <span class='j_link-text' title='http://'></span></span>";i+="<span class='vote-content-edit'><a class='j_link-edit'>\u4fee\u6539</a><a class='j_link-del'>\u79fb\u9664</a></span>";i+="</span>";i+="<div class='msg' style='display:none'><p class='error'>\u94fe\u63a5\u4e0d\u6b63\u786e\u6216\u8005\u5305\u542b\u5916\u94fe\u53ca\u6dd8\u5b9d\u5e97\u94fa\u3001\u5546\u54c1\u3001\u6dd8\u5ba2\u7b49\u94fe\u63a5</p></div>";g.innerHTML=i;g.id="voteImage"+(f++);e.get("j_vote-image").appendChild(g);return g},creates:function(h){var h=h||1,g=[];for(var j=0;j<h;j++){g.push(c.create());var k=c.optionText();if(k.length>=60){e.setStyle("j_add_item","display","none");return g}}return g},getChlid:function(j,l,g){var k=j.getElementsByTagName(l);for(var h=0;h<k.length;h++){if(k[h].className==g){return k[h]}}},addBind:function(g){d.on(e.get(g),"click",function(){c.init(4)})},submitBind:function(g){d.on(e.get(g),"click",function(){c.ajaxSubmit()})},tips:function(){if(e.getFirstChild("j_vote-image").id=="voteImage0"){var h=document.createElement("div");h.id="img_vote_tips";e.get("voteImage0").appendChild(h);e.setStyle("voteImage0","position","relative");h.innerHTML="<a id='img_vote_tips_close' style='float:right;width:20px;height:20px;cursor:pointer'></a>";point=[50,255];e.setStyle(h,"position","absolute");e.setStyle(e.get("img_vote_tips"),"left",point[0]+"px");e.setStyle(h,"top",point[1]+"px");e.setStyle(h,"display","block");d.on("img_vote_tips_close","click",function(){this.parentNode.style.display="none"});var g=c.getChlid(e.get("voteImage0"),"input","vote-content-text");g.style.color="#ccc";g.value="\u9009\u9879\u63cf\u8ff0\uff0c\u9009\u586b";d.on(g,"focus",function(){if(g.value=="\u9009\u9879\u63cf\u8ff0\uff0c\u9009\u586b"){g.value="";g.style.color="#000"}})}},init:function(j){if(j){var l=c.creates(j)}else{var l=e.getChildrenBy(e.get("j_vote-image"),function(i){if(!i.id){i.id="clone"+new Date()}return i.className!="close"&&i.tagName=="LI"})}var h=e.getChildrenBy(e.get("j_vote-image"),function(i){return i.className=="close"&&i.tagName=="LI"});for(var k=0;k<h.length;k++){var g=c.getChlid(h[k],"span","j_link-text");if(g.title!="http://"&&g.title!=""){g.parentNode.style.display="inline-block";if(g.title.length>19){g.innerHTML=g.title.substr(0,19)+"..."}c.getChlid(h[k],"img","j_link").style.display="none"}}for(var k=0;k<l.length;k++){c.show(c.getChlid(l[k],"span","vote-content"));c.link(c.getChlid(l[k],"img","j_link"));c.linkTrue(c.getChlid(l[k],"input","j_add-true"));c.imgAdd(c.getChlid(l[k],"img","vote-content-img"));c.linkFalse(c.getChlid(l[k],"a","j_add-false"));c.linkDel(c.getChlid(l[k],"a","j_link-del"));c.linkEdit(c.getChlid(l[k],"a","j_link-edit"));c.close(l[k].getElementsByTagName("a")[0]);var g=c.getChlid(l[k],"span","j_link-text");if(g.title!="http://"){g.parentNode.style.display="inline-block";if(g.title.length>19){g.innerHTML=g.title.substr(0,19)+"..."}c.getChlid(l[k],"img","j_link").style.display="none";c.getChlid(l[k],"span","vote-content-edit").style.display="inline-block"}}},show:function(g){d.on(g.parentNode,"mouseover",function(){e.setStyle(g,"background","#F3F3F3");g.parentNode.getElementsByTagName("span")[0].className="vote-header2"});d.on(g.parentNode,"mouseout",function(){e.setStyle(g,"background","#fff");g.parentNode.getElementsByTagName("span")[0].className="vote-header"})},optionText:function(){var j=e.getChildrenBy(e.get("j_vote-image"),function(i){return i.style.display!="none"&&i.tagName=="LI"});for(var g=0,h=1;g<j.length;g++){if(j[g].style.display!="none"){c.getChlid(j[g],"span","title").innerHTML="\u9009\u9879"+h;h++}}return j},close:function(g){d.on(g,"click",function(k){if(!confirm("\u662f\u5426\u5220\u9664\u6b64\u9009\u9879?")){d.stopEvent(k);return}else{var l=e.get("j_vote-image").getElementsByTagName("li");var j=0;for(var h=0;h<l.length;h++){if(l[h].style.display!="none"){j++}}if(j>2){g.parentNode.parentNode.style.display="none";c.optionText()}else{alert("\u64cd\u4f5c\u5931\u8d25\uff0c\u9009\u9879\u81f3\u5c11\u4e3a2\u9879");return}e.setStyle("j_add_item","display","block")}})},link:function(g){e.setStyle(g,"cursor","pointer");d.on(g,"click",function(){e.setStyle(e.get("img_vote_tips"),"display","none");e.setStyle(g,"display","none");e.setStyle(e.getNextSibling(g),"display","inline-block");var h=c.getChlid(g.parentNode,"input","j_add-text");var i=c.getChlid(g.parentNode,"span","j_link-text");h.value=i.title})},getTime:function(){return(e.get("J_Year").value+"-"+e.get("J_Month").value+"-"+e.get("J_Date").value+" "+e.get("J_Hour").value)},linkTrue:function(h){d.on(h,"click",function(){var j=e.getPreviousSibling(h).value;var i=e.getNextSibling(h.parentNode);if(j.substr(0,7)!="http://"){j="http://"+j;e.getPreviousSibling(h).value=j}var k=j.replace(/[A-Z]/g,function(l){return String.fromCharCode(l.charCodeAt(0)+32)});if(!g(k)){if(j.length>19){var k=j.substr(0,19)+"..."}c.getChlid(i,"span","j_link-text").innerHTML=k||j;c.getChlid(i,"span","j_link-text").title=j;e.setStyle(h.parentNode,"display","none");e.setStyle(i,"display","block");e.setStyle(e.getNextSibling(i),"display","block");c.getChlid(e.getAncestorBy(h,function(l){return l.tagName=="LI"}),"div","msg").style.display="none"}else{c.getChlid(e.getAncestorBy(h,function(l){return l.tagName=="LI"}),"div","msg").style.display="block"}});function g(k){var i=/.taobao.com/g;var j=new RegExp(/.taobao.com/);if(j.test(k)&&k.substr(0,7)=="http://"&&k.substr(k.indexOf("."),20).match(i)){return(false)}else{return(true)}}},linkFalse:function(g){e.setStyle(g,"cursor","pointer");d.on(g,"click",function(){e.setStyle(g.parentNode,"display","none");e.setStyle(e.getPreviousSibling(g.parentNode),"display","block");c.getChlid(this.parentNode.parentNode.parentNode,"div","msg").style.display="none";var h=c.getChlid(e.getAncestorBy(g,function(i){return i.tagName=="LI"}),"span","j_link-text");if(h.title!="http://"&&h.title!=""){c.getChlid(e.getAncestorBy(g,function(i){return i.tagName=="LI"}),"span","j_linktext").style.display="inline-block";c.getChlid(e.getAncestorBy(g,function(i){return i.tagName=="LI"}),"span","vote-content-edit").style.display="inline-block";c.getChlid(e.getAncestorBy(g,function(i){return i.tagName=="LI"}),"img","j_link").style.display="none";c.getChlid(e.getAncestorBy(g,function(i){return i.tagName=="LI"}),"input","j_add-text").value=h.title}})},linkDel:function(g){e.setStyle(g,"cursor","pointer");d.on(g,"click",function(){e.setStyle(g.parentNode,"display","none");e.setStyle(e.getPreviousSibling(g.parentNode),"display","none");e.setStyle(c.getChlid(g.parentNode.parentNode,"img","j_link"),"display","block");c.getChlid(g.parentNode.parentNode,"input","j_add-text").value="http://";c.getChlid(g.parentNode.parentNode,"span","j_link-text").title="http://";c.getChlid(g.parentNode.parentNode,"span","j_link-text").innerHTML="";e.setStyle(c.getChlid(g.parentNode.parentNode,"div","msg"),"display","none");if(e.getLastChild(e.getAncestorBy(g,function(h){return h.tagName=="LI"})).className="msg"){c.getChlid(e.getAncestorBy(g,function(h){return h.tagName=="LI"}),"div","msg").style.display="none"}})},linkEdit:function(g){e.setStyle(g,"cursor","pointer");d.on(g,"click",function(){e.setStyle(g.parentNode,"display","none");e.setStyle(e.getPreviousSibling(g.parentNode),"display","none");e.setStyle(c.getChlid(g.parentNode.parentNode,"span","j_add"),"display","inline-block")})},imgAdd:function(g){e.setStyle(g.parentNode,"cursor","pointer");d.on(g.parentNode,"click",function(){e.setStyle(e.get("vote_img"),"display","block");e.get("vote_img").setAttribute("img-id",e.getAncestorBy(g,function(i){return i.tagName=="LI"}).id);var h=e.getXY(g);h=[h[0]-2,h[1]+140];e.setXY("vote_img",h)})},createUpload:function(){d.onDOMReady(function(){var g=document.createElement("div");g.id="vote_img";g.className="vote-img-update";var h="<a class='vote-img-update-close' id='j_update_false2'></a><form id='j_imgUpload' name='imgUpload' action='http://bangpai.daily.taobao.net/json/pic_vote_image_upload.htm' >";h+="<label>\u8bf7\u9009\u62e9\u672c\u5730\u56fe\u7247\u4e0a\u4f20\uff1a</label>";h+="<input type='file' size='40' id='imgFile' unselectable='on' name='imgFile'/>";h+="<label class='tips'>\u53ef\u4ee5\u4e0a\u4f201M\u4ee5\u5185\u7684JPG/JPEG/GIF/PNG\u56fe\u7247\uff0c\u5efa\u8bae\u5c3a\u5bf8180 x 180</label>";h+="<label id='j_imgUploadTips' style='display:none'></label>";h+="<span><input type='button' id='j_imgupdate' name='waterMark' value='\u4e0a\u4f20'/><a class='update-false' id='j_update_false'>\u53d6\u6d88</a></span>";h+="</form>";g.innerHTML=h;document.body.appendChild(g);e.setStyle(g,"cursor","pointer");e.setStyle(g,"display","none");YAHOO.util.Event.on([e.get("j_update_false"),e.get("j_update_false2")],"click",function(i){d.stopEvent(i);e.setStyle("vote_img","display","none");e.get("j_imgUpload").reset()})})},submit:function(j){e.get("j_previewKey").value="false";var h=0;var g=function(){var k=e.get("j_radio1");if(k.checked){return 1}else{return e.get("j_selectInput").value}};var i=function(){var k="";var p=e.getChildrenBy(e.get("j_vote-image"),function(q){return q.className!="close"&&q.tagName=="LI"});for(var m=0;m<p.length;m++){var o=c.getChlid(p[m],"img","vote-content-img").src;var n=c.getChlid(p[m],"input","vote-content-text").value;var l=c.getChlid(p[m],"span","j_link-text").title;if(o=="http://img08.taobaocdn.com/tps/i8/T1FCppXg0fXXXXXXXX-180-180.png"&&n!=""&&n!="\u9009\u9879\u63cf\u8ff0\uff0c\u9009\u586b"){_empty=true;h++}if(o=="http://img08.taobaocdn.com/tps/i8/T1FCppXg0fXXXXXXXX-180-180.png"&&l!=""&&l!="http://"){_empty=true;h++}if(p[m].style.display!="none"&&o!="undefined"&&p[m].className!="close"){k+=(n=="\u9009\u9879\u63cf\u8ff0\uff0c\u9009\u586b"?" ":n)+"\u0010"+(l=="http://"?" ":l)+"\u0010"+(o=="http://img08.taobaocdn.com/tps/i8/T1FCppXg0fXXXXXXXX-180-180.png"?" ":o)+"\u0011"}}return k};e.get("j_options").value=i();if(h>0){if(!confirm("\u60a8\u6709\u9009\u9879\u672a\u4e0a\u4f20\u56fe\u7247\uff0c\u662f\u5426\u7ee7\u7eed\u53d1\u8868?")){d.stopEvent(j);return}else{e.get("maxAnswer").value=g();e.get("endDate").value=c.getTime()}}else{e.get("maxAnswer").value=g();e.get("endDate").value=c.getTime()}},ajaxSubmit:function(){var h=0;var g=function(){var j=e.get("j_radio1");if(j.checked){return 1}else{return e.get("j_selectInput").value}};var i=function(){var j="";var o=e.getChildrenBy(e.get("j_vote-image"),function(p){return p.className!="close"&&p.tagName=="LI"});for(var l=0;l<o.length;l++){var n=c.getChlid(o[l],"img","vote-content-img").src;var m=c.getChlid(o[l],"input","vote-content-text").value;var k=c.getChlid(o[l],"span","j_link-text").title;if(n=="http://img08.taobaocdn.com/tps/i8/T1FCppXg0fXXXXXXXX-180-180.png"&&k!=""){_empty=true;h++}if(o[l].style.display!="none"&&n!="undefined"&&o[l].className!="close"){j+=(m=="\u9009\u9879\u63cf\u8ff0\uff0c\u9009\u586b"?" ":m)+"\u0010"+(k=="http://"?" ":k)+"\u0010"+(n=="http://img08.taobaocdn.com/tps/i8/T1FCppXg0fXXXXXXXX-180-180.png"?" ":n)+"\u0011"}}return j};e.get("j_options").value=i();e.get("maxAnswer").value=g();e.get("endDate").value=c.getTime()},insertLocalImage:function(){var l=e.get("j_imgUpload"),h=b,j=e.get("imgFile").value,k=b.actionUrl,g=this,i;if(!j){e.setStyle(e.get("vote_img"),"display","none");return}if(j&&k){if(h.filter!=="*"){i=j.substring(j.lastIndexOf(".")+1).toLowerCase();if(h.filter.indexOf(i)==-1){l.reset();alert("\u6587\u4ef6\u7c7b\u578b\u4e0d\u6b63\u786e,\u4e0a\u4f20\u56fe\u7247\u683c\u5f0f\u53ea\u652f\u6301 png|gif|jpg|jpeg");e.setStyle(e.get("vote_img"),"display","none");return}}l.setAttribute("enctype","multipart/form-data");a.setForm(l,true);k=imgupload_link+"?time="+new Date();a.asyncRequest("post",k,{upload:function(q){try{var o=YAHOO.lang.JSON.parse(q.responseText);if(o.status==0){var r=o.imgUrl;var m=l.parentNode.getAttribute("img-id");var n=c.getChlid(e.get(m),"img","vote-content-img");n.src=r;e.setStyle(e.get("vote_img"),"display","none");l.reset()}else{if(o.status==1){alert(o.error);l.reset();e.setStyle(e.get("vote_img"),"display","none");return}}}catch(p){alert("\u4e0a\u4f20\u56fe\u7247\u5931\u8d25!")}}})}else{}},select:function(){d.on("j_radio2","click",function(){if(this.checked==true){e.get("j_multiple_span").style.display="inline-block"}});d.on("j_radio1","click",function(){if(this.checked==true){e.get("j_multiple_span").style.display="none"}});if(e.get("j_radio2").checked==true){e.get("j_multiple_span").style.display="inline-block"}},preview:function(){var g=new Flower_MaskLayer({color:"#000",timer:400,zindex:6665});d.on("j_preview","click",function(k){e.get("j_previewKey").value="true";var j=TB.bom.getCookie("cookie1")||TB.bom.getCookie("_l_g_");if(j==""){window.location.replace(location.href);return}e.get("msgpost").value=editor.getData();e.get("header").style.zIndex=3333;if(!e.get("j_text-preview")){var h=document.createElement("div");h.id="j_text-preview";h.className="text-preview";e.setStyle(h,"display","none");document.body.appendChild(h)}c.ajaxSubmit();var i=preview_link+"?_input_charset=utf-8&time="+new Date();a.setForm(document.forms.pollForm);a.asyncRequest("POST",i,{success:function(l){if(l.responseText.indexOf("page-feedback-msg")>-1){e.setStyle("j_msgBox","display","block");e.get("j_msgBox").innerHTML=l.responseText}else{e.setStyle("j_msgBox","display","none");e.get("j_msgBox").innerHTML="";ohtml="<p class='p-v1'><a class='close'></a></p>";ohtml+=l.responseText;ohtml+="<p class='p-v2'><button class='close-v2' type='button'></button></p>";e.get("j_text-preview").innerHTML=ohtml;g.show(function(){e.setStyle("j_text-preview","display","block");e.setStyle("j_text-preview","zIndex",6666);var p=(document.documentElement.scrollTop+(document.documentElement.clientHeight-e.get("j_text-preview").offsetHeight)/2);var o=[(e.getDocumentWidth()-e.get("j_text-preview").offsetWidth)/2,p];e.setXY("j_text-preview",o)})}YAHOO.util.Event.on(window,"resize",function(){if(e.get("j_text-preview").style.display!="none"){e.setStyle("j_text-preview","left",(document.documentElement.scrollWidth-e.get("j_text-preview").offsetWidth)/2+"px")}});var n=e.getFirstChild(e.getFirstChild("j_text-preview")),m=e.getFirstChild(e.getLastChild("j_text-preview"));d.on([n,m],"click",function(){e.setStyle(this.parentNode.parentNode,"display","none");g.hide()})},failure:function(l){}})})}};return c})()})();YAHOO.util.Event.onDOMReady(function(){TB.voteImage.vote.addBind("j_add_item");YAHOO.util.Event.on("j_imgupdate","click",function(a){YAHOO.util.Event.stopEvent(a);TB.voteImage.vote.insertLocalImage()});YAHOO.util.Event.on("j_submit","click",function(a){TB.voteImage.vote.submit(a)});TB.voteImage.vote.createUpload();TB.voteImage.vote.select();TB.voteImage.vote.preview()});
